{% extends "base.html" %}
{% block content %}


<div class="size-full flex-1 overflow-auto">

    <section
        class="mx-4 mt-4 flex items-center justify-center p-4 border bg-white border-gray-300 rounded-lg shadow-sm text-lg font-semibold">
        <p>Información del Sector {{ sector.id }}</p>
    </section>

    {# Mapa y Métricas #}
    <section class="flex gap-4 m-4 flex-col sm:flex-row">

        <article class="flex flex-col p-4 border bg-white border-gray-300 rounded-lg shadow-sm relative sm:w-1/2">
            <h2 class="text-lg font-semibold w-full text-center">Ubicación</h2>
            <div class="flex flex-col text-sm mb-4 gap-1">
                <p class="text-gray-700"><b>Latitud:</b> {{ sector.latitud }} </p>
                <p class="text-gray-700"><b>Longitud:</b> {{ sector.longitud }} </p>
            </div>
            <div id="map" class="w-full h-64 sm:flex-1 rounded-lg"></div>
            <button id="toggleLayer"
                class="absolute top-28 right-6 z-1000 bg-white hover:bg-gray-100 px-3 py-2 rounded-lg shadow-md border border-gray-300 text-sm font-medium transition-colors">
                <i class="fa-solid fa-layer-group"></i>
                <span id="layerName">Satélite</span>
            </button>
        </article>


        <div class="w-full sm:w-1/2 flex flex-col gap-4 h-full">
            <div class="flex gap-4">
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-droplet text-blue-500 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">96.78%</span>
                        <h3 class="text-sm">Humedad</h3>
                    </div>
                </article>
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-temperature-half text-red-600 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">23.1 C°</span>
                        <h3 class="text-sm">Temperatura</h3>
                    </div>
                </article>
            </div>
            <div class="flex gap-4">
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-water text-amber-500 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">64</span>
                        <h3 class="text-sm">Turbidez</h3>
                    </div>
                </article>
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-vial text-green-600 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">12</span>
                        <h3 class="text-sm">Acidez (pH)</h3>
                    </div>
                </article>
            </div>
            <article
                class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                <i class="fa-solid fa-flask text-rose-300 fa-2x"></i>
                <div class="flex flex-col align-items-center">
                    <span class="text-xl font-bold">32</span>
                    <h3 class="text-sm">Salinidad</h3>
                </div>
            </article>
            <article
                class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                <i class="fa-solid fa-check-circle text-green-600 fa-2x"></i>
                <div class="flex flex-col align-items-center">
                    <span class="text-xl font-bold">ALMEJA</span>
                    <h3 class="text-sm">Clasificación</h3>
                </div>
            </article>
        </div>
    </section>

    {# Gráfico #}
    <section class="bg-white border border-gray-300 rounded-lg m-4 p-4 h-112 flex flex-col">
        <h3 class="font-semibold mb-4 shrink-0">
            Valores en Tiempo Real
        </h3>
        <article class="flex-1 flex items-center justify-center rounded-lg bg-green-100">
            <p class="text-gray-600">Gráfico...</p>
        </article>
    </section>

    <section class="flex gap-4 mx-4 mb-4 flex-col sm:flex-row items-stretch">
        <div class="w-full sm:w-1/2 flex min-h-80">
            <div class="bg-white border border-gray-300 rounded-lg shadow-sm flex-1">
                <div class="p-4 flex flex-col h-full">
                    <h6 class="font-semibold mb-3">Logs</h6>
                    <p class="h-72 overflow-auto bg-slate-900 text-cyan-100 p-3 rounded-lg text-sm font-mono flex-1">
                        Iniciando dashboard... <br>
                        ¡Dashboard Iniciado Correctamente! <br>
                        Conectando con la base de datos... <br>
                    </p>

                    <div class="mt-3 flex items-center gap-2 text-gray-500 text-xs">
                        <i class="fa-solid fa-circle-info"></i>
                        <span>Últimos eventos del sistema</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full sm:w-1/2 flex min-h-80">
            <div class="bg-white border border-gray-300 rounded-lg shadow-sm flex-1">
                <div class="p-4 flex flex-col h-full">
                    <h6 class="font-semibold mb-1">Histórico de Clasificaciones</h6>
                    <p class="text-gray-500 text-sm mb-2">
                        Se registran cambios de clasificación
                        (guardado en localStorage).
                    </p>

                    <div class="flex items-center gap-2 mb-3">
                        <button id="btn-clear-history"
                            class="flex gap-2 items-center px-3 py-2 bg-red-600 hover:bg-red-500 active:bg-red-700 text-white rounded-lg text-xs font-medium transition-all shadow-sm shadow-gray-400 active:scale-95">
                            <i class="fa-solid fa-trash"></i> Limpiar
                        </button>
                        <button id="btn-export-history"
                            class="flex gap-2 items-center px-3 py-2 bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white rounded-lg text-xs font-medium transition-all shadow-sm shadow-gray-400 active:scale-95">
                            <i class="fa-solid fa-file-csv"></i> Exportar CSV
                        </button>
                    </div>

                    <div
                        class="overflow-auto bg-slate-50 border border-gray-200 rounded-lg p-3 text-sm font-mono text-gray-700 flex-1">
                        <ul id="clasif-history" class="space-y-1">
                            <!-- items dinámicos -->
                            <li class="text-gray-600">[2025-11-03 22:14] — Clasificación A</li>
                            <li class="text-gray-600">[2025-11-03 22:20] — Clasificación B</li>
                        </ul>
                    </div>

                    <div class="mt-3 flex items-center gap-2 text-gray-500 text-xs">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                        <span>Últimos cambios registrados</span>
                    </div>
                </div>
            </div>
        </div>
    </section>


</div>

<script>
    const lat = {{ sector.latitud }};
    const lng = {{ sector.longitud }};

    const map = L.map('map', {
        center: [lat, lng],
        zoom: 16,
        scrollWheelZoom: true,
        dragging: true,
        touchZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        keyboard: false,
        zoomControl: true
    });

    // Definir las capas de tiles
    const openStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    });

    const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri',
        maxZoom: 18
    });

    // Agregar la capa por defecto
    let currentLayer = openStreetMap;
    currentLayer.addTo(map);

    // Botón para cambiar capas
    document.getElementById('toggleLayer').addEventListener('click', function () {
        const layerNameSpan = document.getElementById('layerName');

        if (currentLayer === openStreetMap) {
            map.removeLayer(openStreetMap);
            esriSatellite.addTo(map);
            currentLayer = esriSatellite;
            layerNameSpan.textContent = 'Mapa';
        } else {
            map.removeLayer(esriSatellite);
            openStreetMap.addTo(map);
            currentLayer = openStreetMap;
            layerNameSpan.textContent = 'Satélite';
        }
    });

    // Marcador fijo
    const marker = L.marker([lat, lng], {
        draggable: false
    }).addTo(map);

    marker.bindPopup(`
    <div class="text-center text-xs">
        <strong>Sector {{ sector.id }}</strong><br>
        <span>Lat: ${lat}</span><br>
        <span>Lng: ${lng}</span>
    </div>
`, {
        // closeOnClick: false,     // No se cierra al hacer clic en el mapa
        // autoClose: false,        // No se cierra cuando se abre otro popup
        // closeButton: false       // Opcional: quita el botón X de cerrar
    });
    // }).openPopup();
</script>

{% endblock %}