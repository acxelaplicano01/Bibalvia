{% extends "base.html" %}
{% block content %}

<div class="size-full flex-1 overflow-auto">

    <section
        class="mx-4 mt-4 flex items-center justify-center p-4 border bg-white border-gray-300 rounded-lg shadow-sm text-lg font-semibold">
        <p>Datos del sector: {{ sector.nombre_sector }}</p>
    </section>

    {# Mapa y Métricas #}
    <section class="flex gap-4 m-4 flex-col sm:flex-row">

        <article class="flex flex-col p-4 border bg-white border-gray-300 rounded-lg shadow-sm relative sm:w-1/2">
            {# <h2 class="text-lg font-semibold w-full text-center">Ubicación</h2> #}
            <div class="flex flex-col text-sm mb-4 gap-1">
                <p class="text-gray-700"><b>Latitud:</b> {{ sector.latitud }} </p>
                <p class="text-gray-700"><b>Longitud:</b> {{ sector.longitud }} </p>

                {% if sector.zonas.exists %}
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <p class="text-gray-700 font-semibold mb-1">
                        <i class="fa-solid fa-map-location-dot text-green-600"></i>
                        Zonas:
                    </p>
                    <div class="flex flex-wrap gap-1">
                        {% for zona in sector.zonas.all %}
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                            {{ zona.nombre }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 text-xs mt-2 italic">
                    <i class="fa-solid fa-info-circle"></i>
                    Sin zonas asignadas
                </p>
                {% endif %}
            </div>
            <div id="map" class="w-full h-64 sm:flex-1 rounded-lg"></div>
            <button id="toggleLayer"
                class="absolute bottom-6 left-6 z-1000 bg-white hover:bg-gray-100 px-3 py-2 rounded-lg shadow-md border border-gray-300 text-sm font-medium transition-colors">
                <i class="fa-solid fa-layer-group"></i>
                <span id="layerName">Satélite</span>
            </button>
        </article>


        <div class="w-full sm:w-1/2 flex flex-col gap-4 h-full">
            <div class="flex gap-4">
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-droplet text-blue-500 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">--</span>
                        <h3 class="text-sm">Humedad</h3>
                    </div>
                </article>
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-temperature-half text-red-600 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">--</span>
                        <h3 class="text-sm">Temperatura</h3>
                    </div>
                </article>
            </div>
            <div class="flex gap-4">
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-water text-amber-500 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">--</span>
                        <h3 class="text-sm">Turbidez</h3>
                    </div>
                </article>
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-vial text-green-600 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold" id="valor-ph">--</span>
                        <h3 class="text-sm">Acidez (pH)</h3>
                    </div>
                </article>
            </div>
            <div class="flex gap-4">
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-flask text-rose-300 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">--</span>
                        <h3 class="text-sm">Salinidad</h3>
                    </div>
                </article>
                <article
                    class="bg-white flex gap-4 p-4 border border-gray-300 rounded-lg shadow-sm h-max w-full items-center">
                    <i class="fa-solid fa-lungs text-cyan-600 fa-2x"></i>
                    <div class="flex flex-col align-items-center">
                        <span class="text-xl font-bold">--</span>
                        <h3 class="text-sm">Oxígeno</h3>
                    </div>
                </article>
            </div>


            {% if IS_LOCAL %}
            <button type="button" id="leerDatos" onclick="leerDatos()"
                class="bg-green-700 text-white flex gap-4 px-4 py-6 rounded-lg shadow-md h-max w-full justify-center items-center active:scale-98 hover:bg-green-600 transition-all">
                <i class="fa-solid fa-circle-play fa-2x"></i>
                <div class="flex flex-col align-items-center">
                    <span class="text-xl font-semibold">Leer Sensores</span>
                </div>
            </button>
            {% else %}
            <div
                class="bg-gray-100 text-gray-500 flex gap-4 px-4 py-6 rounded-lg shadow-md h-max w-full justify-center items-center">
                <i class="fa-solid fa-lock fa-2x"></i>
                <div class="flex flex-col align-items-center">
                    <span class="text-xl font-semibold">Lectura de Sensores Deshabilitada en la Nube</span>
                </div>
            </div>
            {% endif %}
    </section>

    {# Gráfico #}
    <section class="bg-white border border-gray-300 rounded-lg m-4 p-4 h-112 flex flex-col">
        <h3 class="font-semibold mb-4 shrink-0">
            Valores en Tiempo Real
        </h3>
        <article class="flex-1 rounded-lg relative">
            <canvas id="sensorChart"></canvas>
        </article>
        <div class="mt-3 text-gray-500 text-xs">
            <i class="fa-solid fa-info-circle"></i>
            <span>Mostrando últimas 20 lecturas de sensores</span>
        </div>
    </section>

    <!-- Tabla de historial con filtros integrados -->
    <section class="bg-white border border-gray-300 rounded-lg m-4 p-4">
        <!-- Header con título -->
        <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200">
            <h3 class="font-semibold text-lg flex items-center gap-2">
                Historial de Lecturas
            </h3>
            <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                {{ lecturas_combinadas|length }} registro{{ lecturas_combinadas|length|pluralize }}
            </span>
        </div>

        <!-- Filtros de fechas -->
        <form method="GET" class="mb-4 pb-4 border-b border-gray-200">
            <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
                <div class="flex-1 w-full sm:w-auto">
                    <label for="fecha_inicio" class="text-sm font-semibold mb-1 block text-gray-700">
                        <i class="fa-solid fa-calendar-days text-blue-500"></i>
                        Fecha Inicio
                    </label>
                    <input type="datetime-local" name="fecha_inicio" id="fecha_inicio" value="{{ fecha_inicio }}"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>

                <div class="flex-1 w-full sm:w-auto">
                    <label for="fecha_fin" class="text-sm font-semibold mb-1 block text-gray-700">
                        <i class="fa-solid fa-calendar-check text-blue-500"></i>
                        Fecha Fin
                    </label>
                    <input type="datetime-local" name="fecha_fin" id="fecha_fin" value="{{ fecha_fin }}"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>

                <div class="flex gap-2 w-full sm:w-auto">
                    <button type="submit"
                        class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 shadow-sm">
                        <i class="fa-solid fa-filter"></i>
                        <span>Filtrar</span>
                    </button>

                    <a href="{% url 'sector_detail' sector.id %}"
                        class="flex-1 sm:flex-none bg-gray-200 hover:bg-gray-300 active:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 shadow-sm">
                        <i class="fa-solid fa-rotate-left"></i>
                        <span>Reset</span>
                    </a>
                </div>
            </div>
        </form>

        <!-- Tabla -->
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <div class="overflow-y-auto max-h-[60vh]">
                <table class="w-full min-w-full text-sm">
                    <thead
                        class="bg-linear-to-r from-gray-50 to-gray-100 text-xs uppercase text-gray-600 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold border-b-2 border-gray-300">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-clock text-gray-500"></i>
                                    Fecha/Hora
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left font-semibold border-b-2 border-gray-300">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-temperature-half text-red-500"></i>
                                    Temp.
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left font-semibold border-b-2 border-gray-300">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-vial text-green-600"></i>
                                    pH
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left font-semibold border-b-2 border-gray-300">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-water text-amber-500"></i>
                                    Turbidez
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left font-semibold border-b-2 border-gray-300">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-droplet text-blue-500"></i>
                                    Humedad
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for lectura in lecturas_combinadas %}
                        <tr class="hover:bg-blue-50 transition-colors">
                            <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-700">
                                <div class="flex flex-col">
                                    <span class="text-xs text-gray-500">{{ lectura.marca_tiempo|date:"d/m/Y" }}</span>
                                    <span class="font-semibold">{{ lectura.marca_tiempo|date:"H:i:s" }}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% if lectura.temperatura %}
                                <span class="text-red-600 font-bold">{{ lectura.temperatura.valor|floatformat:1}}°C</span>
                                {% else %}
                                <span class="text-gray-300 text-xs">Sin datos</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% if lectura.ph %}
                                <span class="text-green-600 font-bold">{{ lectura.ph.valor|floatformat:2 }}</span>
                                {% else %}
                                <span class="text-gray-300 text-xs">Sin datos</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% if lectura.turbidez %}
                                <span class="text-amber-600 font-bold">{{ lectura.turbidez.valor|floatformat:0 }}</span>
                                <span class="text-gray-500 text-xs ml-1">NTU</span>
                                {% else %}
                                <span class="text-gray-300 text-xs">Sin datos</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% if lectura.humedad %}
                                <span class="text-blue-600 font-bold">{{ lectura.humedad.valor|floatformat:1 }}</span>
                                <span class="text-gray-500 text-xs">%</span>
                                {% else %}
                                <span class="text-gray-300 text-xs">Sin datos</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-4 py-16 text-center">
                                <div class="flex flex-col items-center gap-4 text-gray-400">
                                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                        <i class="fa-solid fa-inbox text-3xl"></i>
                                    </div>
                                    <div>
                                        <p class="text-lg font-semibold text-gray-600 mb-1">No hay datos disponibles</p>
                                        <p class="text-sm text-gray-500">Intenta ajustar el rango de fechas o espera a
                                            que se registren nuevas lecturas</p>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer con información -->
        <div
            class="mt-4 pt-3 border-t border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs text-gray-500">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-info-circle text-blue-500"></i>
                <span>Mostrando máximo 100 registros más recientes</span>
            </div>
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-clock text-gray-400"></i>
                <span>Última actualización: {{ lecturas_combinadas.0.marca_tiempo|date:"d/m/Y H:i" }}</span>
            </div>
        </div>
    </section>


    <section class="flex gap-4 mx-4 mb-4 flex-col sm:flex-row items-stretch">
        <div class="w-full sm:w-1/2 flex">
            <div class="bg-white border border-gray-300 rounded-lg shadow-sm flex-1">
                <div class="p-4 flex flex-col h-full">
                    <h6 class="font-semibold mb-3">Logs</h6>
                    <div class="h-64 overflow-auto bg-slate-900 text-cyan-100 p-3 rounded-lg text-sm font-mono">
                        Iniciando dashboard... <br>
                        ¡Dashboard Iniciado Correctamente! <br>
                        Conectando con la base de datos... <br>
                    </div>

                    <div class="mt-3 flex items-center gap-2 text-gray-500 text-xs">
                        <i class="fa-solid fa-circle-info"></i>
                        <span>Últimos eventos del sistema</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full sm:w-1/2 flex">
            <div class="bg-white border border-gray-300 rounded-lg shadow-sm flex-1">
                <div class="p-4 flex flex-col h-full">
                    <h6 class="font-semibold mb-3">Anexos</h6>

                    <!-- INPUT -->
                    {% if IS_LOCAL %}
                    <label
                        class="border border-dashed border-gray-400 rounded-lg p-4 text-center text-sm cursor-pointer hover:bg-gray-50">
                        <input type="file" accept="image/*" class="hidden" id="uploadImg">
                        Haz clic para subir una imagen
                    </label>
                    {% endif %}

                    <!-- GRID DE IMÁGENES -->
                    <div id="previewGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-4 overflow-auto h-64">
                        {% for img in imagenes %}
                        <div class="relative group">
                            <img src="{{ MEDIA_URL }}sectores/{{ img }}" class="rounded-lg object-cover w-full h-28">

                            <!-- BOTÓN BORRAR -->
                            <button onclick="borrarImagen('{{ img }}')"
                                class="absolute top-1 right-1 px-2 py-1 bg-red-600 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

{# Gráfico #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Buffer de datos para el gráfico
    const MAX_POINTS = 20;
    // En el buffer
    const buffer = {
        labels: [],
        temperatura: [],
        turbidez: [],
        humedad: [],
        ph: []  // ← NUEVO
    };

    function nowLabel() {
        const now = new Date();
        return now.toLocaleTimeString('es-HN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // Inicializar Chart.js
    const ctx = document.getElementById('sensorChart').getContext('2d');
    const sensorChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: buffer.labels,
            // En los datasets del gráfico
            datasets: [
                {
                    label: 'Humedad (%)',
                    data: buffer.humedad,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13,110,253,0.08)',
                    tension: 0.25,
                    yAxisID: 'y'
                },
                {
                    label: 'Temperatura (°C)',
                    data: buffer.temperatura,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220,53,69,0.06)',
                    tension: 0.25,
                    yAxisID: 'y'
                },
                {
                    label: 'pH',  // ← NUEVO
                    data: buffer.ph,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16,185,129,0.06)',
                    tension: 0.25,
                    yAxisID: 'y2'
                },
                {
                    label: 'Turbidez (NTU)',
                    data: buffer.turbidez,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245,158,11,0.06)',
                    tension: 0.25,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Humedad (%) / Temperatura (°C)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    max: 1000,
                    title: {
                        display: true,
                        text: 'Turbidez (NTU)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                },
                y2: {  // ← NUEVO
                    type: 'linear',
                    display: false,  // Oculto para no saturar
                    position: 'right',
                    min: 0,
                    max: 14,
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });

    function pushDataPoint(datos) {
        buffer.labels.push(nowLabel());
        buffer.temperatura.push(Number(datos.temperatura?.toFixed(1) || 0));
        buffer.turbidez.push(Number(datos.turbidez || 0));
        buffer.humedad.push(Number(datos.humedad?.toFixed(1) || 0));
        buffer.ph.push(Number(datos.ph?.toFixed(2) || 7));  // ← NUEVO

        // Mantener solo MAX_POINTS
        if (buffer.labels.length > MAX_POINTS) {
            buffer.labels.shift();
            buffer.temperatura.shift();
            buffer.turbidez.shift();
            buffer.humedad.shift();
            buffer.ph.shift();  // ← NUEVO
        }

        // Actualizar gráfico
        sensorChart.update('none');
    }
</script>

<script>
    let contador = {{ siguiente_num }};
    const sectorID = {{ sector.id }};     // viene de Django
    const input = document.getElementById('uploadImg');
    const grid = document.getElementById('previewGrid');

    input.addEventListener('change', () => {
        const file = input.files[0];
        if (!file) return;

        // --- PREVIEW EN GRID ---
        const reader = new FileReader();
        reader.onload = e => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = "rounded-lg shadow-sm object-cover w-full h-28";
            grid.appendChild(img);
        };
        reader.readAsDataURL(file);

        // --- ENVÍO AL BACKEND ---
        const formData = new FormData();
        const extension = file.name.split('.').pop();
        const newName = `sector${sectorID}-imagen${contador}.${extension}`;
        formData.append('imagen', file, newName);
        formData.append('sector_id', sectorID);

        fetch("{% url 'upload_imagen_sector' %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    location.reload(); // Recarga para actualizar siguiente_num
                }
            });
        contador++;
    });

    function borrarImagen(nombre) {
        fetch("{% url 'borrar_imagen_sector' %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nombre: nombre })
        }).then(() => location.reload());
    }
</script>
<script>

    let reading = false;
    let eventSource = null;

    function leerDatos() {
        const btn = document.getElementById('leerDatos');

        if (!reading) {
            btn.innerHTML = `
            <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
            <div class="flex align-items-center">
                <span class="text-xl font-semibold">Detener</span>
            </div>
        `;
            btn.classList.remove('bg-green-700', 'hover:bg-green-600');
            btn.classList.add('bg-blue-700', 'hover:bg-blue-600');

            fetch("{% url 'iniciar_lectura_sensores' %}", {
                method: "POST",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`Error: ${data.error}\nPuerto: ${data.puerto}`);
                        leerDatos();
                        return;
                    }

                    eventSource = new EventSource("{% url 'stream_sensores' %}?sector_id={{ sector.id }}");

                    eventSource.onmessage = function (event) {
                        const datos = JSON.parse(event.data);

                        if (datos.status === 'cerrado') {
                            eventSource.close();
                            return;
                        }

                        if (datos.error) {
                            console.error('Error:', datos.error);
                            return;
                        }

                        actualizarValores(datos);
                    };

                    eventSource.onerror = function (error) {
                        console.error('Error EventSource:', error);
                        eventSource.close();
                        leerDatos();
                    };
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al iniciar lectura');
                    leerDatos();
                });

        } else {
            btn.innerHTML = `
            <i class="fa-solid fa-circle-play fa-2x"></i>
            <div class="flex flex-col align-items-center">
                <span class="text-xl font-semibold">Leer Sensores</span>
            </div>
        `;
            btn.classList.remove('bg-blue-700', 'hover:bg-blue-600');
            btn.classList.add('bg-green-700', 'hover:bg-green-600');

            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            fetch("{% url 'detener_lectura_sensores' %}", {
                method: "POST",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
        }

        reading = !reading;
    }

    function actualizarValores(datos) {
        // Temperatura
        if (datos.temperatura !== undefined && datos.temperatura !== -999) {
            const tempElement = document.querySelector('.fa-temperature-half').nextElementSibling.querySelector('.font-bold');
            tempElement.textContent = `${datos.temperatura.toFixed(1)} C°`;
        }

        // Turbidez
        if (datos.turbidez !== undefined) {
            const turbElement = document.querySelector('.fa-water').nextElementSibling.querySelector('.font-bold');
            turbElement.textContent = datos.turbidez.toFixed(0);
        }

        // Humedad
        if (datos.humedad !== undefined) {
            const humedadElement = document.querySelector('.fa-droplet').nextElementSibling.querySelector('.font-bold');
            humedadElement.textContent = `${datos.humedad.toFixed(1)}%`;
        }

        // pH ← NUEVO
        if (datos.ph !== undefined) {
            const phElement = document.getElementById('valor-ph');
            phElement.textContent = datos.ph.toFixed(2);

            // Colorear según el pH
            if (datos.ph < 6.5) {
                phElement.classList.add('text-red-600');
                phElement.classList.remove('text-green-600', 'text-blue-600');
            } else if (datos.ph > 8.5) {
                phElement.classList.add('text-blue-600');
                phElement.classList.remove('text-red-600', 'text-green-600');
            } else {
                phElement.classList.add('text-green-600');
                phElement.classList.remove('text-red-600', 'text-blue-600');
            }
        }

        // Actualizar gráfico
        pushDataPoint(datos);

        // Animación
        document.querySelectorAll('.fa-temperature-half, .fa-water, .fa-droplet, .fa-vial').forEach(icon => {
            const card = icon.closest('article');
            card.classList.add('ring-2', 'ring-green-400');
            setTimeout(() => card.classList.remove('ring-2', 'ring-green-400'), 500);
        });

        // Log
        const logElement = document.querySelector('.bg-slate-900');
        const timestamp = new Date().toLocaleTimeString();
        logElement.innerHTML += `[${timestamp}] Temp: ${datos.temperatura?.toFixed(1)}°C | Turbidez: ${datos.turbidez?.toFixed(0)} NTU | Humedad: ${datos.humedad?.toFixed(1)}% | pH: ${datos.ph?.toFixed(2)}<br>`;
        logElement.scrollTop = logElement.scrollHeight;
    }

    window.addEventListener('beforeunload', function () {
        if (reading && eventSource) {
            eventSource.close();
            fetch("{% url 'detener_lectura_sensores' %}", {
                method: "POST",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
        }
    });

</script>

<script>
    const lat = {{ sector.latitud }};
    const lng = {{ sector.longitud }};

    /* prettier-ignore */
    // Zonas del sector desde Django
    const zonasDelSector = [
        {% for zona in sector.zonas.all %}
    {
        id: {{ zona.id }},
        nombre: "{{ zona.nombre|escapejs }}",
            geopoligono: {{ zona.geopoligono | safe }}
    } {% if not forloop.last %}, {% endif %}
    {% endfor %}
    ];


    const map = L.map('map', {
        center: [lat, lng],
        zoom: 16,
        scrollWheelZoom: true,
        dragging: true,
        touchZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        keyboard: false,
        zoomControl: true
    });

    // Capas de tiles
    const openStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    });

    const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri',
        maxZoom: 18
    });

    let currentLayer = openStreetMap;
    currentLayer.addTo(map);

    document.getElementById('toggleLayer').addEventListener('click', function () {
        const layerNameSpan = document.getElementById('layerName');

        if (currentLayer === openStreetMap) {
            map.removeLayer(openStreetMap);
            esriSatellite.addTo(map);
            currentLayer = esriSatellite;
            layerNameSpan.textContent = 'Mapa';
        } else {
            map.removeLayer(esriSatellite);
            openStreetMap.addTo(map);
            currentLayer = openStreetMap;
            layerNameSpan.textContent = 'Satélite';
        }
    });

    // Dibujar zonas en el mapa
    zonasDelSector.forEach(zona => {
        const coords = zona.geopoligono.coordinates[0].map(c => [c[1], c[0]]);
        const poligono = L.polygon(coords, {
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.25,
            weight: 2
        }).addTo(map);

        // Tooltip al pasar el mouse
        poligono.bindTooltip(zona.nombre, {
            permanent: false,
            direction: 'center',
            opacity: 0.9
        });
    });

    // Marcador del sector
    const marker = L.marker([lat, lng], {
        draggable: false
    }).addTo(map);

    marker.bindPopup(`
        <div class="text-center text-xs">
            <strong>Sector {{ sector.id }}</strong><br>
            <span>Lat: ${lat}</span><br>
            <span>Lng: ${lng}</span>
            ${zonasDelSector.length > 0 ? `
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <div class="text-left">
                        <strong class="text-green-600">Zonas:</strong><br>
                        ${zonasDelSector.map(z => `<span class="text-xs">• ${z.nombre}</span>`).join('<br>')}
                    </div>
                </div>
            ` : ''}
        </div>
    `);

    // Ajustar vista del mapa para incluir zonas si existen
    if (zonasDelSector.length > 0) {
        const bounds = L.latLngBounds([[lat, lng]]);
        zonasDelSector.forEach(zona => {
            zona.geopoligono.coordinates[0].forEach(c => {
                bounds.extend([c[1], c[0]]);
            });
        });
        map.fitBounds(bounds, { padding: [50, 50] });
    }
</script>

{% endblock %}