{% extends "base.html" %}

{% block nav_title %}
    <span class="font-semibold">Registrar Sector</span>
{% endblock %}

{% block content %}

<div class="bg-white rounded-lg h-full flex flex-col sm:flex-row sm:overflow-hidden">
    <!-- Mapa -->
    <div id="map" class="size-full min-h-64 sm:h-full shadow-md"></div>

    <form method="POST" class="bg-white flex flex-col h-max p-4 sm:h-full sm:w-2/5">
        {% csrf_token %}
        <!-- Mensajes de Django -->
        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div
                class="p-3 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <div class="flex w-full gap-4 flex-col mb-4">
            <div class="flex flex-col w-full">
                <label class="mb-1 font-semibold" for="latitud">Latitud</label>
                <input name="latitud" id="latitud"
                    class="shadow-md text-xs sm:text-sm border rounded-lg border-gray-400 p-2" type="text"
                    placeholder="Ej: 13.309">
            </div>
            <div class="flex flex-col w-full">
                <label class="mb-1 font-semibold" for="longitud">Longitud</label>
                <input name="longitud" id="longitud"
                    class="shadow-md text-xs sm:text-sm border rounded-lg border-gray-400 p-2" type="text"
                    placeholder="Ej: -87.178">
            </div>
        </div>

        <button type="button" id="btnUbicacion"
            class="text-sm shadow-xl bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500 active:bg-blue-700 transition-colors mb-4">
            <i class="fa-solid fa-location-crosshairs"></i>
            Ubicación Actual
        </button>

        <div class="flex gap-4">
            <a href="{% url 'home' %}"
                class="text-sm shadow-xl w-1/2 items-center flex justify-center gap-2 bg-red-800 text-white px-4 py-2 rounded-lg hover:bg-red-700 active:bg-red-900 transition-colors mb-4">
                <i class="fa-solid fa-ban"></i>
                <span>Cancelar</span>
            </a>
            <button type="submit" id="btnGuardar"
                class="text-sm shadow-xl w-1/2 items-center flex justify-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-500 active:bg-green-700 transition-colors mb-4">
                <i class="fa-solid fa-thumbtack"></i>
                <span>Guardar</span>
            </button>
        </div>
    </form>
</div>

<script>
    // Inicializar mapa centrado en Choluteca
    const map = L.map('map').setView([13.31065966, -87.17890633], 8);

    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Marcador que se moverá
    let marker = null;
    let actualizandoProgramaticamente = false; // Flag para evitar loops infinitos

    // Función para actualizar la ubicación
    function actualizarUbicacion(lat, lng, zoom = null, actualizarInputs = true) {

        // Validar coordenadas
        if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            return;
        }

        // Actualizar inputs solo si no vienen de los inputs mismos
        if (actualizarInputs) {
            actualizandoProgramaticamente = true;
            document.getElementById('latitud').value = lat.toFixed(8);
            document.getElementById('longitud').value = lng.toFixed(8);
            actualizandoProgramaticamente = false;
        }

        // Actualizar inputs
        // document.getElementById('latitud').value = lat.toFixed(8);
        // document.getElementById('longitud').value = lng.toFixed(8);

        // Si ya existe un marcador, moverlo
        if (marker) {
            marker.setLatLng([lat, lng]);
            marker.setPopupContent(`Lat: ${lat.toFixed(8)}<br>Lng: ${lng.toFixed(8)}`);
        } else {
            // Crear nuevo marcador
            marker = L.marker([lat, lng]).addTo(map)
                .bindPopup(`Lat: ${lat.toFixed(8)}<br>Lng: ${lng.toFixed(8)}`)
                .openPopup();
        }

        // Centrar mapa en la ubicación
        if (zoom) {
            map.setView([lat, lng], zoom);
        } else {
            map.panTo([lat, lng]);
        }
    }

    // Crear marcador inicial en las coordenadas de Choluteca
    actualizarUbicacion(13.31065966, -87.17890633);

    // Al hacer clic en el mapa
    map.on('click', function (e) {
        actualizarUbicacion(e.latlng.lat, e.latlng.lng);
    });

    // Actualizar mapa cuando se editan los inputs
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');

    function actualizarDesdeInputs() {
        if (actualizandoProgramaticamente) return; // Evitar loop infinito

        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);

        if (!isNaN(lat) && !isNaN(lng)) {
            actualizarUbicacion(lat, lng, null, false);
        }
    }

    // Escuchar cambios en tiempo real
    latInput.addEventListener('input', actualizarDesdeInputs);
    lngInput.addEventListener('input', actualizarDesdeInputs);

    // También actualizar al perder el foco (blur) para centrar el mapa
    latInput.addEventListener('blur', function () {
        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);
        if (!isNaN(lat) && !isNaN(lng)) {
            map.setView([lat, lng], map.getZoom());
        }
    });

    lngInput.addEventListener('blur', function () {
        const lat = parseFloat(latInput.value);
        const lng = parseFloat(lngInput.value);
        if (!isNaN(lat) && !isNaN(lng)) {
            map.setView([lat, lng], map.getZoom());
        }
    });

    // Botón de ubicación actual
    document.getElementById('btnUbicacion').addEventListener('click', function () {
        const btn = this;
        const originalHTML = btn.innerHTML;

        // Cambiar texto del botón
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Obteniendo ubicación...';
        btn.disabled = true;

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // Actualizar ubicación con zoom más cercano
                    actualizarUbicacion(lat, lng, 18);

                    // Restaurar botón
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;

                    // Mostrar precisión en el popup
                    marker.bindPopup(`
                        Lat: ${lat.toFixed(8)}<br>
                        Lng: ${lng.toFixed(8)}<br>
                        Precisión: ±${accuracy.toFixed(0)}m
                    `).openPopup();
                },
                function (error) {
                    let mensaje = '';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            mensaje = "Permiso de ubicación denegado. Por favor, habilita el acceso a tu ubicación.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensaje = "Información de ubicación no disponible.";
                            break;
                        case error.TIMEOUT:
                            mensaje = "Tiempo de espera agotado al obtener ubicación.";
                            break;
                        default:
                            mensaje = "Error desconocido al obtener ubicación.";
                    }
                    alert(mensaje);

                    // Restaurar botón
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                },
                {
                    enableHighAccuracy: true,  // Máxima precisión (usa GPS)
                    timeout: 10000,            // Esperar máximo 10 segundos
                    maximumAge: 0              // No usar caché
                }
            );
        } else {
            alert("Tu navegador no soporta geolocalización");
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    });
</script>
{% endblock %}