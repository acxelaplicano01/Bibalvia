<!doctype html>
<html lang="es">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Bibalvia · Dashboard IoT</title>
		<!-- Bootstrap 5 CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
		<style>
			body { background:#f5f7fb; }
			.metric { font-size: 1.6rem; font-weight:700 }
			.metric-sub { font-size:0.85rem; color:#6b7280 }
			.card-compact { padding: .8rem; }
			#sim-image { max-width:100%; height:auto; border-radius:6px }
			pre.logs { height:295px; overflow:auto; background:#0b1220; color:#cfe8ff; padding:10px; border-radius:6px }
			/* Blink animation para alertas */
			@keyframes blink { 50% { opacity: 0.1; } }
			.badge.blink { animation: blink 0.8s step-start infinite; }
			/* Historia de clasificaciones */
			ul.history-list { list-style:none; margin:0; padding:0; max-height:200px; overflow:auto }
			ul.history-list li { padding:6px 8px; border-bottom:1px solid #e9eef8; font-size:0.9rem }
		</style>
	</head>
	<body>
			<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
				<div class="container-fluid">
					<a class="navbar-brand" href="#"><i class="fa-solid fa-seedling"></i> Bibalvia</a>
					<div class="d-flex align-items-center text-light">
						<small id="last-update">Última actualización: nunca</small>
						<span class="badge bg-secondary ms-3" id="conn-status">WS: desconectado</span>
					</div>
				</div>
			</nav>

		<main class="container my-4">
			<div class="row g-3">
				<div class="col-12 col-lg-8">
					<div class="card shadow-sm">
						<div class="card-body">
							<h5 class="card-title">Valores en tiempo real</h5>
							<canvas id="mainChart" height="140"></canvas>
							<div class="mt-3 text-muted"><small>Nota: los datos que se muestran aquí son simulados por defecto. Reemplace la función de simulación por su fuente real (WebSocket o REST).</small></div>
						</div>
					</div>
				</div>

				<div class="col-12 col-lg-4">
					<div class="row g-3">
						<div class="col-6 col-md-12">
							<div class="card card-compact shadow-sm">
								<div class="d-flex align-items-center">
									<div class="me-3">
										<i class="fa-solid fa-droplet fa-2x text-primary"></i>
									</div>
									<div>
										<div class="metric" id="soil-value">-- %</div>
										<div class="metric-sub">Humedad del suelo</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-6 col-md-12">
							<div class="card card-compact shadow-sm">
								<div class="d-flex align-items-center">
									<div class="me-3">
										<i class="fa-solid fa-temperature-half fa-2x text-danger"></i>
									</div>
									<div>
										<div class="metric" id="temp-value">-- °C</div>
										<div class="metric-sub">Temperatura</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-6 col-md-12">
							<div class="card card-compact shadow-sm">
								<div class="d-flex align-items-center">
									<div class="me-3">
										<i class="fa-solid fa-sun fa-2x text-warning"></i>
									</div>
									<div>
                                        <div class="metric" id="turb-value">--</div>
                                        <div class="metric-sub">Turbidez</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-6 col-md-12">
							<div class="card card-compact shadow-sm">
								<div class="d-flex align-items-center">
									<div class="me-3">
										<i class="fa-solid fa-bell fa-2x text-success"></i>
									</div>
									<div>
										<div class="metric" id="buzzer-value">OFF</div>
										<div class="metric-sub">Buzzer / Alarma</div>
									</div>
								</div>
							</div>
						</div>

						<!-- Tarjeta de clasificación -->
						<div class="col-12 col-md-12">
							<div class="card card-compact shadow-sm">
								<div class="d-flex align-items-center">
									<div class="me-3">
										<i class="fa-solid fa-check-circle fa-2x text-muted" id="clasif-icon"></i>
									</div>
									<div>
										<div class="metric" id="clasif-value">--</div>
										<div class="metric-sub" id="clasif-sub">Clasificación</div>
									</div>
									<div class="ms-auto">
										<span id="clasif-badge" class="badge bg-secondary">--</span>
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>

				<div class="col-12 col-lg-6">
					<div class="card shadow-sm">
						<div class="card-body">
							<h6>Simulación / Visual de la protoboard</h6>
							<p class="text-muted">Para mostrar la imagen de la simulación, coloque el archivo <code>Terrific Stantia.png</code> dentro de una carpeta <code>assets</code> en la raíz del proyecto y se mostrará automáticamente aquí.</p>
							<img id="sim-image" src="assets/Terrific Stantia.png" alt="Simulación Tinkercad (coloque assets/Terrific Stantia.png)" onerror="this.style.display='none'">
						</div>
					</div>
				</div>

				<div class="col-12 col-lg-6">
					<div class="card shadow-sm">
						<div class="card-body">
							<h6>Logs</h6>
							<pre class="logs" id="logs">Iniciando dashboard...
							</pre>
							<div class="mt-2 text-muted"><small>Últimos eventos del sistema</small></div>
						</div>
					</div>
				</div>

				<div class="col-12 col-lg-6">
					<div class="card shadow-sm">
						<div class="card-body">
							<h6>Histórico de Clasificaciones</h6>
							<p class="text-muted">Se registran cambios de clasificación (guardado en localStorage).</p>
							<div class="d-flex mb-2">
								<button id="btn-clear-history" class="btn btn-sm btn-outline-danger me-2">Limpiar</button>
								<button id="btn-export-history" class="btn btn-sm btn-outline-primary">Exportar CSV</button>
							</div>
							<ul id="clasif-history" class="history-list">
								<!-- items -->
							</ul>
						</div>
					</div>
				</div>

			</div>
		</main>

		<!-- JS libs -->
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
		<script>
			// Contrato pequeño:
			// - Inputs: datos por sensor (humedad suelo %, temperatura °C, luz lx, estado buzzer boolean)
			// - Output: UI actualizada (tarjetas y chart). Error mode: si no hay datos, muestra '--'.

					// Buffer de datos (mantener últimos 30 puntos)
					const MAX_POINTS = 30;
					const buffer = {
						labels: [],
						soil: [],
						temp: [],
						turbidez: []
					};

			// Inicializa con timestamps vacíos
			function nowLabel() { return new Date().toLocaleTimeString(); }

			// Chart.js setup
			const ctx = document.getElementById('mainChart').getContext('2d');
			const mainChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: buffer.labels,
							datasets: [
									{ label: 'Humedad (%)', data: buffer.soil, borderColor: '#0d6efd', backgroundColor:'rgba(13,110,253,0.08)', tension:0.25 },
									{ label: 'Temperatura (°C)', data: buffer.temp, borderColor: '#dc3545', backgroundColor:'rgba(220,53,69,0.06)', tension:0.25 },
									{ label: 'Turbidez', data: buffer.turbidez, borderColor: '#f59e0b', backgroundColor:'rgba(245,158,11,0.06)', tension:0.25 }
								]
				},
				options: {
					animation: false,
					responsive: true,
					plugins: { legend: { position: 'top' } },
					scales: { y: { beginAtZero: true } }
				}
			});

					// Simulador de sensores (fallback si no hay WS). No activo por defecto cuando hay WS.
					let simInterval = null;
							let last = { soil: 55, temp: 22, turbidez: 50, buzzer: false, clasif: 'NONE' };
							// Simulador con clasificaciones rotativas
							const SIM_CLASIFS = ['OSTRA','MEJILLON','ALMEJA','NONE'];
							let simClasifIdx = 0;
							function simulateSensor() {
								last.soil = Math.max(0, Math.min(100, last.soil + (Math.random()-0.45)*5));
								last.temp = Math.max(-10, Math.min(50, last.temp + (Math.random()-0.5)*0.8));
								last.turbidez = Math.max(0, Math.min(100, last.turbidez + (Math.random()-0.5)*6));
								last.buzzer = last.soil < 25;
								// alternar clasificación cada llamada o cada N llamadas
								simClasifIdx = (simClasifIdx + 1) % SIM_CLASIFS.length;
								last.clasif = SIM_CLASIFS[simClasifIdx];
								return { ...last };
							}

					function pushDataPoint(point) {
						buffer.labels.push(nowLabel());
						buffer.soil.push(Number(point.soil.toFixed(1)));
						buffer.temp.push(Number(point.temp.toFixed(1)));
						buffer.turbidez.push(Math.round(point.turbidez));

				if (buffer.labels.length > MAX_POINTS) {
					buffer.labels.shift(); buffer.soil.shift(); buffer.temp.shift(); buffer.turbidez.shift();
				}

				// actualizar UI
				document.getElementById('soil-value').textContent = point.soil.toFixed(1) + ' %';
				document.getElementById('temp-value').textContent = point.temp.toFixed(1) + ' °C';
			document.getElementById('turb-value').textContent = Math.round(point.turbidez);
			document.getElementById('buzzer-value').textContent = point.buzzer ? 'ON' : 'OFF';

			// actualizar clasificación si viene
			if (point.clasif !== undefined) updateClasif(point.clasif);

				// logs
			const log = `[${new Date().toLocaleTimeString()}] soil=${point.soil.toFixed(1)}% temp=${point.temp.toFixed(1)}°C turbidez=${Math.round(point.turbidez)} buzzer=${point.buzzer}`;
				const logsEl = document.getElementById('logs');
				logsEl.textContent = log + '\n' + logsEl.textContent;
				// actualizar last update
				document.getElementById('last-update').textContent = 'Última actualización: ' + new Date().toLocaleTimeString();

				// actualizar chart
				mainChart.update('none');
			}

			function updateClasif(clasif) {
				const elVal = document.getElementById('clasif-value');
				const elBadge = document.getElementById('clasif-badge');
				const elIcon = document.getElementById('clasif-icon');
				const text = (clasif && typeof clasif === 'string') ? clasif.toUpperCase() : String(clasif);
				elVal.textContent = text || '--';
				// lógica de colores / prioridad:
				// - NONE / AJUSTAR -> rojo (critico)
				// - MEJILLON -> warning (amarillo)
				// - OSTRA / ALMEJA -> success (verde)
				let badgeClass = 'secondary';
				let iconClass = 'text-muted';
				let badgeText = text;
				if (!text || text === 'NONE' || text === 'AJUSTAR') { badgeClass = 'danger'; iconClass='text-danger'; badgeText='AJUSTAR'; }
				else if (text.includes('MEJILLON')) { badgeClass = 'warning'; iconClass='text-warning'; }
				else { badgeClass = 'success'; iconClass='text-success'; }
				elBadge.className = 'badge bg-' + badgeClass;
				elBadge.textContent = badgeText;
				elIcon.className = 'fa-solid fa-check-circle fa-2x ' + iconClass;
				// alerta visual adicional: si crítico, resaltar logs
				if (badgeClass === 'danger') {
					appendLog('ALERTA: clasificación crítica -> ' + badgeText);
					// efecto visual y sonoro
					document.getElementById('clasif-badge').classList.add('blink');
					beepCritical();
					// quitar el parpadeo después de 6s
					setTimeout(()=>document.getElementById('clasif-badge').classList.remove('blink'), 6000);
				}
				// guardar en histórico
				pushHistory(text);
			}

			// Histórico en localStorage
			const HISTORY_KEY = 'bibalvia:clasifHistory';
			function loadHistory(){
				try{ const raw = localStorage.getItem(HISTORY_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
			}
			function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
			function pushHistory(clasif){
				const h = loadHistory();
				const entry = { ts: Date.now(), clasif: clasif };
				h.unshift(entry);
				// mantener 200 elementos
				if (h.length > 200) h.pop();
				saveHistory(h);
				renderHistory();
			}
			function renderHistory(){
				const list = document.getElementById('clasif-history');
				list.innerHTML = '';
				const h = loadHistory();
				for (const it of h) {
					const li = document.createElement('li');
					const d = new Date(it.ts).toLocaleString();
					li.textContent = `${d} — ${it.clasif}`;
					list.appendChild(li);
				}
			}
			function clearHistory(){ localStorage.removeItem(HISTORY_KEY); renderHistory(); }

			// Exportar CSV
			function exportHistoryCSV(){
				const h = loadHistory();
				let csv = 'timestamp,datetime,clasif\n';
				for (const r of h) {
					csv += `${r.ts},"${new Date(r.ts).toISOString()}",${r.clasif}\n`;
				}
				const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a'); a.href = url; a.download = 'clasif_history.csv'; a.click(); URL.revokeObjectURL(url);
			}

			// Notificación sonora via Web Audio (beep corto)
			let audioCtx = null;
			function beepCritical(){
				try{
					if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
					const o = audioCtx.createOscillator();
					const g = audioCtx.createGain();
					o.type = 'sine'; o.frequency.value = 420; g.gain.value = 0.03;
					o.connect(g); g.connect(audioCtx.destination);
					o.start(); setTimeout(()=>{ o.stop(); }, 160);
				}catch(e){ console.warn('Audio no disponible', e); }
			}

					// Loop de simulación (fallback). startSimulation y stopSimulation controlan el simulador.
					function startSimulation(interval = 2000) {
						if (simInterval) return;
						for (let i=0;i<8;i++) pushDataPoint(simulateSensor());
						simInterval = setInterval(() => pushDataPoint(simulateSensor()), interval);
						appendLog('Simulador iniciado (fallback)');
					}
					function stopSimulation() {
						if (!simInterval) return;
						clearInterval(simInterval); simInterval = null;
						appendLog('Simulador detenido');
					}

					function appendLog(text) {
						const logsEl = document.getElementById('logs');
						logsEl.textContent = `[${new Date().toLocaleTimeString()}] ${text}\n` + logsEl.textContent;
					}

					// Integración con WebSocket: conecta a ws://localhost:8080 por defecto.
					let ws = null;
					let reconnectMs = 1000;
					const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.hostname + ':8080';

					function setConnStatus(text, cls='secondary'){
						const el = document.getElementById('conn-status');
						el.textContent = text;
						el.className = 'badge ms-3 bg-' + cls;
					}

					function connectWebSocket(url) {
						appendLog('Intentando conectar WS ' + url);
						ws = new WebSocket(url);
						ws.onopen = () => {
							appendLog('WS conectado');
							setConnStatus('WS: conectado','success');
							stopSimulation();
							reconnectMs = 1000; // reset
						};
						ws.onmessage = (evt) => {
							try {
								const msg = JSON.parse(evt.data);
								// Soporta el puente server.js: {type:'sensor', data: {...}, ts:...}
								if (msg.type === 'sensor' && msg.data) {
									const d = msg.data;
									// mapeo esperado: tempC, turbidez, salinidad, vivo, clasif
									const point = {
										soil: (d.salinidad !== undefined) ? Number(d.salinidad) : (d.soil || 0),
										temp: (d.tempC !== undefined) ? Number(d.tempC) : (d.temp || 0),
										turbidez: (d.turbidez !== undefined) ? Number(d.turbidez) : (d.turbidez || 0),
										buzzer: (d.vivo !== undefined) ? Boolean(d.vivo) : false,
										clasif: d.clasif || d.clasif || ''
									};
									pushDataPoint(point);
									if (point.clasif) appendLog('Clasificación: ' + point.clasif);
								} else if (msg.type === 'text' && msg.data) {
									appendLog('Serial: ' + msg.data);
								} else {
									// si el servidor envía directamente el JSON del sensor
									if (msg.tempC !== undefined || msg.salinidad !== undefined) {
										const d = msg;
										pushDataPoint({ soil: d.salinidad||0, temp: d.tempC||0, turbidez: d.turbidez||0, buzzer: d.vivo||false });
									}
								}
							} catch(e) {
								console.error('WS parse error', e, evt.data);
							}
						};
						ws.onclose = () => {
							appendLog('WS cerrado, reintentando en ' + reconnectMs + 'ms');
							setConnStatus('WS: desconectado','secondary');
							// iniciar simulador si no hay conexión tras 2 intentos
							setTimeout(() => { if (!ws || ws.readyState !== 1) startSimulation(2000); }, 1500);
							setTimeout(() => setTimeout(() => connectWebSocket(url), reconnectMs), 0);
							reconnectMs = Math.min(30000, reconnectMs * 1.5);
						};
						ws.onerror = (e) => { console.error('WS error', e); ws.close(); };
					}

			// O alternativa: consultas REST periódicas
			/*
			async function pollREST(url, interval=2000) {
				setInterval(async () => {
					const res = await fetch(url);
					const data = await res.json();
					pushDataPoint(data);
				}, interval);
			}
			// Ejemplo: pollREST('/api/sensors');
			*/

					// Iniciar: intentar conectar WS; si falla, se iniciará el simulador como fallback.
					window.addEventListener('load', () => {
						setConnStatus('WS: conectando...','info');
						try { connectWebSocket(WS_URL); }
						catch(e){ console.error('WS start error', e); startSimulation(2000); }
						// si no se conecta en 3s, iniciar simulador como fallback
						setTimeout(() => { if (!ws || ws.readyState !== 1) startSimulation(2000); }, 3000);

						// attach history buttons
						document.getElementById('btn-clear-history').addEventListener('click', () => { clearHistory(); appendLog('Histórico limpiado'); });
						document.getElementById('btn-export-history').addEventListener('click', () => { exportHistoryCSV(); appendLog('Exportando histórico'); });
						renderHistory();
					});
		</script>
	</body>
</html>
